generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}



enum UserRole {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  EMAIL_VERIFIED
  PHONE_VERIFIED
}

enum TokenType {
  PASSWORD_RESET
  EMAIL_VERIFY
  PHONE_VERIFY
}
enum ProductStatus {
  DRAFT
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
  DISCONTINUED
}

enum ProductType {
  PERFUME
  BODY_SPRAY
  CANDLE
  DIFFUSER
  ROOM_SPRAY
  GIFT_SET
  SAMPLE
}

enum ConcentrationLevel {
  EAU_FRAICHE
  EAU_DE_COLOGNE
  EAU_DE_TOILETTE
  EAU_DE_PARFUM
  PARFUM
  EXTRAIT
}

enum Season {
  SPRING
  SUMMER
  FALL
  WINTER
  ALL_SEASON
}

enum Gender {
  MENS
  WOMENS
  UNISEX
}
enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
  FAILED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PAYPAL
  BANK_TRANSFER
  COD
  WALLET
}


// ============================================
// USER MANAGEMENT
// ============================================
model User {
  // Basic Identification
  id          String  @id @default(uuid()) @db.Uuid
  firstName   String? @db.VarChar(40)
  lastName    String? @db.VarChar(40)
  middleName  String? @db.VarChar(40)
  displayName String? @db.VarChar(100)

  email            String  @unique
  emailVerified    Boolean @default(false)
  phoneCountryCode String  @db.VarChar(5)
  phoneNumber      String  @unique
  phoneVerified    Boolean @default(false)
  password         String

  // Account Management
  type        UserRole   @default(USER)
  status      UserStatus @default(ACTIVE)
  avatar      String?
  dateOfBirth DateTime?
  gender      String?    @db.VarChar(20)

  // Marketing & Communication Preferences
  acceptsMarketing     Boolean @default(false)
  newsletterSubscribed Boolean @default(false)
  emailNotifications   Boolean @default(true)
  smsNotifications     Boolean @default(false)

  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastLoginAt       DateTime?
  passwordUpdatedAt DateTime?

  // Relations
  userTokens    UserToken[]
  reviews       Review[]
  wishlists     WishlistItem[]
  cart          Cart?
  orders        Order[]
  inventoryLogs InventoryLog[]
  addresses     Address[]

  // Indexes
  @@index([phoneCountryCode, phoneNumber], name: "user_phone_idx")
  @@index([email], name: "user_email_idx")
  @@index([status], name: "user_status_idx")
  @@index([createdAt], name: "user_created_at_idx")
}

model UserToken {
  id        String    @id @default(uuid()) @db.Uuid
  type      TokenType
  token     String    @unique // Added unique constraint
  userId    String    @db.Uuid
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  usedAt    DateTime? // Track if token has been used
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([type, userId], name: "idx_user_token")
  @@index([token], name: "idx_token")
}

model RefreshTokenBlacklist {
  id        String   @id @default(uuid()) @db.Uuid
  reference String   @unique @db.VarChar(255)
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([expiresAt], name: "idx_blacklist_expires")
}

// ============================================
// PRODUCT CATALOG
// ============================================


model Product {
  id          String  @id @default(uuid()) @db.Uuid
  sku         String  @unique @db.VarChar(50)
  name        String  @db.VarChar(200)
  slug        String  @unique @db.VarChar(250)
  description String? @db.Text

  // Pricing
  price        Decimal  @db.Decimal(10, 2)
  comparePrice Decimal? @db.Decimal(10, 2)
  costPrice    Decimal? @db.Decimal(10, 2)

  // Inventory
  quantity       Int     @default(0)
  trackQuantity  Boolean @default(true)
  allowBackorder Boolean @default(false)
  lowStockAlert  Int     @default(5)

  // Product Details
  type          ProductType
  concentration ConcentrationLevel?
  gender        Gender
  season        Season[]

  // Fragrance Notes
  topNotes    String[]
  middleNotes String[]
  baseNotes   String[]

  // Specifications
  volume      Int?     @db.Integer
  weight      Decimal? @db.Decimal(8, 2)
  ingredients String?  @db.Text
  howToUse    String?  @db.Text

  // Marketing & SEO
  featured        Boolean @default(false)
  status          ProductStatus @default(DRAFT)
  tags            String[]
  metaTitle       String? @db.VarChar(200)
  metaDescription String? @db.VarChar(500)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // Relations
  images         ProductImage[]
  categories     ProductCategory[]
  variants       ProductVariant[]
  reviews        Review[]
  wishlists      WishlistItem[]
  cartItems      CartItem[]
  orderItems     OrderItem[]
  inventoryLogs  InventoryLog[]
  discountUsages DiscountUsage[]

  // Indexes
  @@index([sku], name: "idx_product_sku")
  @@index([slug], name: "idx_product_slug")
  @@index([status], name: "idx_product_status")
  @@index([type], name: "idx_product_type")
  @@index([gender], name: "idx_product_gender")
  @@index([featured], name: "idx_product_featured")
  @@index([createdAt], name: "idx_product_created")
  @@index([price], name: "idx_product_price")
}

model ProductImage {
  id        String  @id @default(uuid()) @db.Uuid
  productId String  @db.Uuid
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  url       String
  altText   String? @db.VarChar(200)
  sortOrder Int     @default(0)
  isPrimary Boolean @default(false)

  @@index([productId], name: "idx_image_product")
  @@index([sortOrder], name: "idx_image_sort")
}

model Category {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @db.VarChar(100)
  slug        String    @unique @db.VarChar(150)
  description String?   @db.Text
  image       String?
  parentId    String?   @db.Uuid
  parent      Category? @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Restrict)
  children    Category[] @relation("CategoryHierarchy")
  products    ProductCategory[]

  // SEO
  metaTitle       String? @db.VarChar(200)
  metaDescription String? @db.VarChar(500)

  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug], name: "idx_category_slug")
  @@index([parentId], name: "idx_category_parent")
  @@index([sortOrder], name: "idx_category_sort")
  @@index([isActive], name: "idx_category_active")
}

model ProductCategory {
  id         String   @id @default(uuid()) @db.Uuid
  productId  String   @db.Uuid
  categoryId String   @db.Uuid
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([productId, categoryId])
  @@index([productId], name: "idx_prodcat_product")
  @@index([categoryId], name: "idx_prodcat_category")
}

model ProductVariant {
  id           String   @id @default(uuid()) @db.Uuid
  productId    String   @db.Uuid
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  sku          String   @unique @db.VarChar(50)
  name         String   @db.VarChar(100)
  price        Decimal  @db.Decimal(10, 2)
  comparePrice Decimal? @db.Decimal(10, 2)
  costPrice    Decimal? @db.Decimal(10, 2)
  quantity     Int      @default(0)
  weight       Decimal? @db.Decimal(8, 2)
  volume       Int?     @db.Integer
  isActive     Boolean  @default(true)
  sortOrder    Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  cartItems      CartItem[]
  orderItems     OrderItem[]
  inventoryLogs  InventoryLog[]

  @@index([productId], name: "idx_variant_product")
  @@index([sku], name: "idx_variant_sku")
  @@index([isActive], name: "idx_variant_active")
}

model InventoryLog {
  id            String          @id @default(uuid()) @db.Uuid
  productId     String          @db.Uuid
  product       Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId     String?         @db.Uuid
  variant       ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  type          String          @db.VarChar(20)
  quantity      Int
  previousStock Int
  newStock      Int
  reason        String?         @db.Text
  createdById   String?         @db.Uuid
  createdBy     User?           @relation(fields: [createdById], references: [id], onDelete: SetNull)
  createdAt     DateTime        @default(now())

  @@index([productId], name: "idx_invlog_product")
  @@index([variantId], name: "idx_invlog_variant")
  @@index([createdAt], name: "idx_invlog_created")
  @@index([type], name: "idx_invlog_type")
}

// ============================================
// REVIEWS & WISHLIST
// ============================================

model Review {
  id         String  @id @default(uuid()) @db.Uuid
  productId  String  @db.Uuid
  product    Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId     String  @db.Uuid
  user       User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  rating     Int     @db.SmallInt
  title      String? @db.VarChar(200)
  comment    String? @db.Text
  longevity  Int?    @db.SmallInt
  sillage    Int?    @db.SmallInt
  projection Int?    @db.SmallInt
  isVerified Boolean @default(false)
  helpfulCount Int   @default(0)
  status     String  @default("PENDING") @db.VarChar(20)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([productId, userId])
  @@index([productId], name: "idx_review_product")
  @@index([userId], name: "idx_review_user")
  @@index([rating], name: "idx_review_rating")
  @@index([createdAt], name: "idx_review_created")
  @@index([status], name: "idx_review_status")
}

model WishlistItem {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  productId String   @db.Uuid
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@index([userId], name: "idx_wishlist_user")
  @@index([productId], name: "idx_wishlist_product")
}

// ============================================
// SHOPPING CART
// ============================================

model Cart {
  id          String     @id @default(uuid()) @db.Uuid
  userId      String     @unique @db.Uuid
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       CartItem[]
  itemsCount  Int        @default(0)
  totalAmount Decimal    @default(0) @db.Decimal(10, 2)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([userId], name: "idx_cart_user")
}

model CartItem {
  id        String          @id @default(uuid()) @db.Uuid
  cartId    String          @db.Uuid
  cart      Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String          @db.Uuid
  product   Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId String?         @db.Uuid
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  quantity  Int             @default(1)
  price     Decimal         @db.Decimal(10, 2)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@unique([cartId, productId, variantId])
  @@index([cartId], name: "idx_cartitem_cart")
  @@index([productId], name: "idx_cartitem_product")
}

// ============================================
// ORDERS & PAYMENTS
// ============================================



model Order {
  id          String   @id @default(uuid()) @db.Uuid
  orderNumber String   @unique @db.VarChar(50)
  userId      String   @db.Uuid
  user        User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Order totals
  subtotal       Decimal @db.Decimal(10, 2)
  discountAmount Decimal @default(0) @db.Decimal(10, 2)
  taxAmount      Decimal @default(0) @db.Decimal(10, 2)
  shippingAmount Decimal @default(0) @db.Decimal(10, 2)
  totalAmount    Decimal @db.Decimal(10, 2)

  // Status
  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)
  paymentMethod PaymentMethod

  // Customer snapshot
  customerEmail     String
  customerFirstName String
  customerLastName  String
  customerPhone     String?

  // Addresses
  shippingAddressId String? @db.Uuid
  billingAddressId  String? @db.Uuid
  shippingAddress   Address? @relation("ShippingAddress", fields: [shippingAddressId], references: [id], onDelete: SetNull)
  billingAddress    Address? @relation("BillingAddress", fields: [billingAddressId], references: [id], onDelete: SetNull)

  // Legacy address fields (snapshot)
  shippingFirstName    String
  shippingLastName     String
  shippingCompany      String?
  shippingAddressLine1 String
  shippingAddressLine2 String?
  shippingCity         String
  shippingState        String
  shippingPostalCode   String
  shippingCountry      String
  shippingPhone        String?
  
  billingFirstName    String
  billingLastName     String
  billingCompany      String?
  billingAddressLine1 String
  billingAddressLine2 String?
  billingCity         String
  billingState        String
  billingPostalCode   String
  billingCountry      String

  // Payment
  paymentIntentId String? @unique
  transactionId   String?

  // Shipping
  trackingNumber String?
  carrier        String?
  shippedAt      DateTime?
  deliveredAt    DateTime?

  // Discount
  discountId   String?  @db.Uuid
  discount     Discount? @relation(fields: [discountId], references: [id], onDelete: SetNull)
  discountCode String?  @db.VarChar(50)

  // Notes
  customerNote String? @db.Text
  internalNote String? @db.Text

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  cancelledAt DateTime?
  refundedAt  DateTime?

  // Relations
  items    OrderItem[]
  payments Payment[]

  @@index([userId], name: "idx_order_user")
  @@index([orderNumber], name: "idx_order_number")
  @@index([status], name: "idx_order_status")
  @@index([paymentStatus], name: "idx_order_payment_status")
  @@index([createdAt], name: "idx_order_created")
}

model OrderItem {
  id          String          @id @default(uuid()) @db.Uuid
  orderId     String          @db.Uuid
  order       Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String          @db.Uuid
  product     Product         @relation(fields: [productId], references: [id], onDelete: Restrict)
  variantId   String?         @db.Uuid
  variant     ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  productName  String
  productSku   String
  variantName  String?
  productImage String?
  price        Decimal  @db.Decimal(10, 2)
  comparePrice Decimal? @db.Decimal(10, 2)
  quantity     Int
  total        Decimal  @db.Decimal(10, 2)
  createdAt    DateTime @default(now())

  @@index([orderId], name: "idx_orderitem_order")
  @@index([productId], name: "idx_orderitem_product")
}

model Payment {
  id              String        @id @default(uuid()) @db.Uuid
  orderId         String        @db.Uuid
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("USD") @db.VarChar(3)
  paymentMethod   PaymentMethod
  paymentIntentId String?
  transactionId   String?
  processor       String?       @db.VarChar(50)
  status          PaymentStatus @default(PENDING)
  failureReason   String?       @db.Text
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([orderId], name: "idx_payment_order")
  @@index([paymentIntentId], name: "idx_payment_intent")
  @@index([transactionId], name: "idx_payment_transaction")
  @@index([createdAt], name: "idx_payment_created")
}

// ============================================
// SHIPPING
// ============================================

model Address {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @db.Uuid
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  firstName    String   @db.VarChar(50)
  lastName     String   @db.VarChar(50)
  company      String?  @db.VarChar(100)
  addressLine1 String   @db.VarChar(200)
  addressLine2 String?  @db.VarChar(200)
  city         String   @db.VarChar(100)
  state        String   @db.VarChar(100)
  postalCode   String   @db.VarChar(20)
  country      String   @db.VarChar(2)
  phone        String?  @db.VarChar(20)
  isDefault    Boolean  @default(false)
  type         String   @default("BOTH") @db.VarChar(20) // SHIPPING, BILLING, BOTH
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  shippingOrders Order[] @relation("ShippingAddress")
  billingOrders  Order[] @relation("BillingAddress")

  @@index([userId], name: "idx_address_user")
  @@index([isDefault], name: "idx_address_default")
}

model ShippingZone {
  id        String         @id @default(uuid()) @db.Uuid
  name      String         @db.VarChar(100)
  countries String[]
  isActive  Boolean        @default(true)
  rates     ShippingRate[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@index([isActive], name: "idx_shipzone_active")
}

model ShippingRate {
  id              String       @id @default(uuid()) @db.Uuid
  shippingZoneId  String       @db.Uuid
  shippingZone    ShippingZone @relation(fields: [shippingZoneId], references: [id], onDelete: Cascade)
  name            String       @db.VarChar(100)
  price           Decimal      @db.Decimal(10, 2)
  minOrderAmount  Decimal?     @db.Decimal(10, 2)
  maxOrderAmount  Decimal?     @db.Decimal(10, 2)
  estimatedDays   String?      @db.VarChar(50)
  isActive        Boolean      @default(true)
  sortOrder       Int          @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([shippingZoneId], name: "idx_shiprate_zone")
  @@index([isActive], name: "idx_shiprate_active")
}

// ============================================
// DISCOUNTS & PROMOTIONS
// ============================================

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
}

model Discount {
  id                  String       @id @default(uuid()) @db.Uuid
  code                String       @unique @db.VarChar(50)
  name                String       @db.VarChar(100)
  description         String?      @db.Text
  type                DiscountType
  value               Decimal      @db.Decimal(10, 2)
  usageLimit          Int?
  usedCount           Int          @default(0)
  minOrderAmount      Decimal?     @db.Decimal(10, 2)
  maxDiscountAmount   Decimal?     @db.Decimal(10, 2)
  startsAt            DateTime?
  expiresAt           DateTime?
  isActive            Boolean      @default(true)
  appliesToAllProducts Boolean     @default(true)
  productIds          String[]
  categoryIds         String[]
  oncePerCustomer     Boolean      @default(false)
  customerIds         String[]
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  // Relations
  orders         Order[]
  discountUsages DiscountUsage[]

  @@index([code], name: "idx_discount_code")
  @@index([isActive], name: "idx_discount_active")
  @@index([expiresAt], name: "idx_discount_expires")
}

model DiscountUsage {
  id         String   @id @default(uuid()) @db.Uuid
  discountId String   @db.Uuid
  discount   Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)
  userId     String   @db.Uuid
  productId  String?  @db.Uuid
  product    Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  orderId    String?  @db.Uuid
  usedAt     DateTime @default(now())

  @@index([discountId], name: "idx_usage_discount")
  @@index([userId], name: "idx_usage_user")
  @@index([usedAt], name: "idx_usage_date")
}